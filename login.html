<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="css/globals.css">
    <link rel="stylesheet" href="css/theme.css">

    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/footer.css">

    <link rel="stylesheet" href="css/button.css">

    <link rel="stylesheet" href="css/login.css">
</head>
<body data-colors-schema="light">
    <div class="login-wrapper">
        <section class="login-container">
            <form onsubmit="return false">
                <label><span class="required">*</span> Github username:</label>
                <input type="text" id="username">
                <span id="error-message"></span>
                <br>
                <button class="button button-theme-blue" id="login-button" disabled>Login</button>
                <a class="button" href="/posts.html">Cancelar</a>
            </form>
            
            <div id="user-avatar">
                <span id="loading"></span>
            </div>
        </section>
    </div>
    <script>
        const usernameInput = document.getElementById('username')
        const loginButton = document.getElementById('login-button')

        const userAvatar = document.getElementById('user-avatar')
        const loadingSpan = document.getElementById('loading')
        const errorMessage = document.getElementById('error-message')

        let user;

        function debounce(fn, delay) {
            let timeoutId;
            return (...args) => {
                loginButton.disabled = true
                userAvatar.setAttribute('style', 'background-image: none')
                loadingSpan.setAttribute('style', 'display: block;')
                errorMessage.innerText = ''
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn(...args), delay);
            };
        }

        function signIn() {
            console.log('Login ->', user)
            window.location.href = '/'
        }

        async function request(username) {
            loadingSpan.setAttribute('style', 'display: none;')
            if(!username) {
                errorMessage.innerText = ''

                return
            }

            const response = await fetch(`https://api.github.com/users/${username}`)
            console.log('request - ' + username);

            try {
                if(response.ok) {
                    const data = await response.json()

                    loginButton.disabled = false
                    userAvatar.setAttribute('style', `background-image: url(${data.avatar_url})`)
                    user = data
                } else {
                    userAvatar.setAttribute('style', 'background-image: none;')

                    if(response.status == 404) {
                        errorMessage.innerText = '* Usuário não encontrado'
                    }
                }
            } catch (error) {
                window.alert("Erro na requisição")
                console.error(error)
            }
        }

        const debouncedFetch = debounce((e) => request(e.target.value), 1000);

        usernameInput.addEventListener("input", debouncedFetch);
        loginButton.onclick = function(ev) {
            signIn()
        }
    </script>
</body>
</html>